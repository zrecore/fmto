<!DOCTYPE html>
<html lang="en">
    <head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" href="/test/img/favicon.ico" type="image/x-icon">
		<title>FMTO - index.test</title>
		<link rel="stylesheet" type="text/css" href="/test/style.css" />
	</head>
	<body>
		<h1>FMTO - Test Suite</h1>
		<canvas id="gpuCanvas"></canvas>
		<ol>
			<li><a href="/test/suite/core.test.html">/test/suite/core.test.html</a></li>
			<li><a href="/test/suite/default/default-render.test.html">/test/suite/default/default-render.test.html</a></li>
			<li><a href="/test/suite/default/default-interstage-variables.test.html">/test/suite/default/default-interstage-variables.test.html</a></li>
			<li><a href="/test/suite/default/default-interstage-variables-connect-by-location.test.html">/test/suite/default/default-interstage-variables-connect-by-location.test.html</a></li>
			<li><a href="/test/suite/default/default-interstage-variables-checkerboard.test.html">/test/suite/default/default-interstage-variables-checkerboard.test.html</a></li>
			<li><a href="/test/suite/lib/matrix.test.html">/test/suite/lib/matrix.test.html</a></li>
			<li><a href="/test/suite/lib/vector.test.html">/test/suite/lib/vector.test.html</a></li>
			<li><a href="/test/suite/math/linear-algebra/cross-product.test.html">/test/suite/math/linear-algebra/cross-product.test.html</a></li>
			<li><a href="/test/suite/math/linear-algebra/dot-product.test.html">/test/suite/math/linear-algebra/dot-product.test.html</a></li>
		</ol>
		<script type="module">
			import {
				Core,
				BreadthFirst,
				DepthFirst,

				LinearAlgebra,
				Calculus,
				DifferentialEquations,

				DefaultRender
			} from '/src/index.mjs'

			try {
				const core = new Core()
				
				const hasAdapter = await core.initializeAdapter()
				const hasDevice = await core.initializeDevice()

				if (hasAdapter && hasDevice)
				{
					const device = core.device
					// Attempt to use canvas element #gpuCanvas
					// See example at https://dev.to/ndesmic/basic-webgpu-rendering-2kob
					// Somewhat out of date, but I was able to update to 
					// current syntax as of this writing
					// (August 2024)
					const canvas = document.getElementById('gpuCanvas')
					const context = canvas.getContext('webgpu')
					context.configure({
						device,
						format: 'bgra8unorm'
					})
					// Set up vertex buffer
					const vertices = new Float32Array([
						// point x, point y, point z, 	color r, color g, color b, color a
						
						-1.0, -1.0, 0, 		1, 0, 0, 1,
						1.0, -1.0, 0, 		0, 1, 0, 1,
						1.0, 1.0, 0, 		0, 1, 1, 1,
						-1.0, 1.0, 0, 		0, 0, 1, 1
					])
					const view = context
						.getCurrentTexture()
						.createView()
					
					const BUFFER_SIZE = vertices.byteLength
					// Create the shader module
					const shader = `
						struct VertexOut {
							@builtin(position) position: vec4<f32>,
							@location(0) color: vec4<f32>
						};

						@vertex
						fn vertex_main( @location(0) position: vec4<f32>,
										@location(1) color: vec4<f32>) -> VertexOut
						{
							var output : VertexOut;
							output.position = position;
							output.color = color;

							return output;
						}

						@fragment
						fn fragment_main(fragData: VertexOut) -> @location(0) vec4<f32>
						{
							return fragData.color;
						}
					`

					const render = new DefaultRender(
						device,
						view,
						vertices,
						BUFFER_SIZE,
						shader
					)
					
					// Render!
					render.run()
				} else {
					throw "Could not initialize WebGPU adapter or WebGPU device."
				}
			} catch (ex)
			{
				console.error(ex)
			}

		</script>
	</body>
</html>